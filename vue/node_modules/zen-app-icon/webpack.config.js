const TerserPlugin = require('terser-webpack-plugin'),
  { VueLoaderPlugin } = require('vue-loader'),
  path = require('path')
function optimization(mode) {
  if (mode === 'production') {
    return {
      splitChunks: false,
      minimize: true,
      minimizer: [
        new TerserPlugin({
          terserOptions: {
            ecma: undefined,
            parse: {},
            compress: {},
            mangle: true, // Note `mangle.properties` is `false` by default.
            module: false,
            // Deprecated
            output: null,
            format: null,
            toplevel: true,
            nameCache: null,
            ie8: false,
            keep_classnames: undefined,
            keep_fnames: false,
            safari10: false,
          },
        }),
      ],
    }
  }
  return {}
}

var webpackConfig = {
  entry: {
    main: './main.js',
  },
  output: {
    filename: '[name].js',
  },
  watchOptions: {
    ignored: ['node_modules', 'dist', 'debug'],
    poll: true,
  },
  externals: {
    vue: 'Vue',
  },
  plugins: [new VueLoaderPlugin()],
  resolve: {
    alias: {
      '@util': path.resolve(__dirname, 'src/util'),
      '@icon': path.resolve(__dirname, 'node_modules/zen-app-icon/src'),
    },
    extensions: ['.js', '.vue', '.json'],
  },
  module: {
    noParse: /Vue|jquery/,
    rules: [
      {
        test: /\.m?js$/,
        exclude: /(node_modules|bower_components)/,
        use: {
          loader: 'babel-loader',
          options: {
            cacheDirectory: true,
            presets: ['@babel/preset-env'],
            plugins: [
              '@babel/plugin-transform-runtime',
              '@babel/plugin-syntax-jsx',
              '@vue/babel-plugin-jsx',
            ],
          },
        },
      },
      {
        test: /\.vue$/,
        loader: 'vue-loader',
      },
      {
        test: /\.css$/,
        use: ['style-loader', 'css-loader'],
      },
      {
        test: /\.scss$/,
        use: [
          'style-loader',
          'css-loader', // translates CSS into CommonJS
          {
            loader: 'sass-loader',
            options: {
              implementation: require('sass'),
            },
          },
        ],
      },
    ],
  },
}
let vuePath = path.resolve(__dirname)

module.exports = (env, argv) => {
  let mode = argv.mode
  webpackConfig.mode = mode
  webpackConfig.optimization = optimization(mode)
  if (mode === 'development') {
    webpackConfig.cache = { type: 'memory' }
    webpackConfig.devServer = {
      open: true,
      hot: true,
      host: '127.0.0.1',
      allowedHosts: 'all',
      static: {
        directory: path.join(vuePath, 'public'),
      },
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': '*',
      },
    }
  } else {
    webpackConfig.output.clean = true
    webpackConfig.output.path = path.join(vuePath, 'dist')
  }
  return webpackConfig
}
